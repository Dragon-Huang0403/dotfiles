#!/bin/zsh
# =============================================================================
# 1Password Secrets Loader (Lazy)
# =============================================================================
# Auto-loads secrets when referenced in commands using `op inject`.
# Touch ID only required on first use.
#
# Usage:
#   echo $OPENAI_API_KEY  # Auto-loads on first use
#   load_secrets          # Manually load all secrets

# Skip if 1Password CLI is not installed
if ! command -v op &>/dev/null; then
  echo "[zsecrets] 1Password CLI (op) not found, skipping secrets loader"
  return 0
fi

_SECRETS_TEMPLATE="${ZDOTDIR:-$HOME}/.env.tpl"
_SECRETS_LOADED=0

# Parse secret names from template (single source of truth)
_get_secret_names() {
  [[ -f "$_SECRETS_TEMPLATE" ]] || return
  grep -oE '^export [A-Z_]+=' "$_SECRETS_TEMPLATE" | sed 's/export //;s/=//'
}

_load_secrets() {
  [[ $_SECRETS_LOADED -eq 1 ]] && return 0

  if [[ ! -f "$_SECRETS_TEMPLATE" ]]; then
    echo "Secrets template not found: $_SECRETS_TEMPLATE" >&2
    return 1
  fi

  while read -r line; do
    eval "$line"
  done < <(op inject -i "$_SECRETS_TEMPLATE")
  _SECRETS_LOADED=1
}

# Preexec hook - auto-load when secrets are referenced
_lazy_secrets_preexec() {
  [[ $_SECRETS_LOADED -eq 1 ]] && return

  local cmd="$1"
  for name in $(_get_secret_names); do
    if [[ "$cmd" == *"\$$name"* || "$cmd" == *"\${$name"* ]]; then
      _load_secrets
      return
    fi
  done
}

autoload -Uz add-zsh-hook
add-zsh-hook preexec _lazy_secrets_preexec

load_secrets() {
  _SECRETS_LOADED=0
  _load_secrets
  echo "Secrets loaded"
}
